# =============================================================================
# VeraLux Receptionist — Nginx Reverse Proxy with TLS Termination
# =============================================================================
# Terminates SSL/TLS and proxies to internal Docker services.
# Supports:
#   - Let's Encrypt via Certbot (auto-renew)
#   - Custom SSL certificates (mounted at /etc/nginx/certs/)
#   - WebSocket upgrade for /media-stream
#   - Rate limiting at the edge
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ── Logging ───────────────────────────────────────
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time uct=$upstream_connect_time';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 50m;

    # ── Gzip ──────────────────────────────────────────
    gzip on;
    gzip_types text/plain application/json application/javascript text/css text/xml;
    gzip_min_length 256;

    # ── Rate Limiting (edge layer) ────────────────────
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=webhook:10m rate=50r/s;

    # ── Upstream Definitions ──────────────────────────
    # In SaaS mode with replicas, Docker DNS resolves to all replica IPs.
    # Using `resolve` with a DNS resolver for dynamic upstream.
    resolver 127.0.0.11 valid=10s ipv6=off;

    upstream control_plane {
        server control:4000;
        keepalive 32;
    }

    upstream runtime {
        ip_hash;              # Sticky sessions — WebSocket reconnects hit same replica
        server runtime:4001;
        keepalive 32;
    }

    # ── Shared proxy headers ──────────────────────────
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ── Include virtual hosts ─────────────────────────
    include /etc/nginx/conf.d/*.conf;
}
