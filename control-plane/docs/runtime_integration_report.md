# Runtime Integration Report

This document is the control-plane side of the runtime contract. It is intentionally precise and used by tooling, but the first sections are still readable for non-developers.

Generated by `scripts/print_runtime_contract.js`.

Source modules:
- src/runtime/runtimePublisher.ts
- src/runtime/runtimeContract.ts
- src/server.ts

Redis keys:
- DID mapping key format: `tenantmap:did:{{DID_E164}}`
- Tenant config key format: `tenantcfg:{{TENANT_ID}}`
- Prefixes: `tenantmap:did:`, `tenantcfg:` (hardcoded; no env-driven prefixes)

RuntimeTenantConfig (representative JSON, secrets redacted):
```json
{
  "contractVersion": "v1",
  "tenantId": "{{TENANT_ID}}",
  "dids": [
    "+15551234567"
  ],
  "webhookSecretRef": "secret://runtime/webhook",
  "webhookSecret": "REDACTED",
  "caps": {
    "maxConcurrentCallsTenant": 10,
    "maxCallsPerMinuteTenant": 60,
    "maxConcurrentCallsGlobal": 200
  },
  "stt": {
    "mode": "whisper_http",
    "whisperUrl": "https://stt.example.com/transcribe",
    "chunkMs": 500,
    "language": "en"
  },
  "tts": {
    "mode": "kokoro_http",
    "kokoroUrl": "https://tts.example.com/tts",
    "voice": "default",
    "format": "wav",
    "sampleRate": 24000
  },
  "audio": {
    "publicBaseUrl": "https://api.example.com/audio",
    "storageDir": "/var/lib/veralux/audio",
    "runtimeManaged": true
  }
}
```
Notes:
- `contractVersion` is currently `v1`.
- `webhookSecretRef` or `webhookSecret` is required by schema; redact `webhookSecret` in docs/logs.

Env vars:
- `REDIS_URL`: Redis connection URL used by runtime publisher.
- `ENABLE_RUNTIME_ADMIN`: Enables runtime admin endpoints; if true and `REDIS_URL` missing, server exits on startup.
- `ALLOW_RUNTIME_SECRET_READ`: Allows `?includeSecrets=1` to return `webhookSecret` from admin endpoints.

Normalization:
- `didE164` is normalized (trim + internal whitespace removal) in admin endpoints before map/unmap/lookup and validated against E.164 regex `/^\+[1-9]\d{1,14}$/`.
- `dids` in `RuntimeTenantConfig` are validated with the same E.164 regex.
- `tenantId` from runtime admin routes is trimmed; runtimePublisher does not normalize tenant IDs.
- All DIDs are normalized to E.164 on publish; runtime assumes normalized lookup.

Failure behavior:
- Redis down/unreachable -> publisher operations throw; admin endpoints return 500 with:
- POST /api/admin/runtime/tenants/:tenantId/config: `{ error: "runtime_publish_failed" }`
- GET /api/admin/runtime/tenants/:tenantId/config: `{ error: "runtime_config_read_failed" }`
- POST /api/admin/runtime/dids/map: `{ error: "runtime_map_failed" }`
- POST /api/admin/runtime/dids/unmap: `{ error: "runtime_unmap_failed" }`
- GET /api/admin/runtime/dids/:didE164: `{ error: "runtime_lookup_failed" }`
- GET /api/admin/runtime/health returns 503 with `{ ok: false, error }` when ping/get fails; 500 with `{ error: "runtime_health_failed" }` on unexpected exceptions.
- If `ENABLE_RUNTIME_ADMIN` is false, runtime admin endpoints return 503 `{ error: "runtime_admin_disabled" }`.
