# =============================================================================
# VeraLux Receptionist — SaaS Multi-Tenant Overlay
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.saas.yml up -d
#
# This overlay:
#   - Enables TLS (nginx reverse proxy)
#   - Scales control plane and runtime to multiple replicas
#   - Enables SaaS mode (self-service signup, billing enforcement)
#   - Adds per-tenant monitoring
#   - Upgrades Postgres to a managed replica-ready config
#
# =============================================================================

services:
  # ── Control Plane: 2 replicas behind nginx ──────────
  control:
    deploy:
      replicas: ${CONTROL_REPLICAS:-2}
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    # Remove direct port exposure (nginx handles it)
    ports: !override []
    environment:
      - SAAS_MODE=true
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
      - ADMIN_ALLOWED_ORIGINS=${ADMIN_ALLOWED_ORIGINS}
      - ADMIN_RATE_USE_REDIS=true
      - ADMIN_RATE_MAX=${ADMIN_RATE_MAX:-200}
      - ADMIN_RATE_WINDOW_MS=${ADMIN_RATE_WINDOW_MS:-300000}
      # Stripe (required for SaaS)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    # Remove container_name so replicas work
    container_name: ""

  # ── Runtime: 2 replicas behind nginx ────────────────
  runtime:
    deploy:
      replicas: ${RUNTIME_REPLICAS:-2}
      resources:
        limits:
          cpus: "4.0"
          memory: 2G
        reservations:
          cpus: "1.0"
          memory: 1G
    # Remove direct port exposure (nginx handles it)
    ports: !override []
    container_name: ""

  # ── Nginx TLS reverse proxy (always on in SaaS) ────
  nginx:
    profiles: []  # Override: always run (remove "tls" profile requirement)
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # ── Redis: production settings ──────────────────────
  redis:
    command: >
      redis-server
      --appendonly yes
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --save 300 100
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 256M

  # ── Postgres: production tuning ─────────────────────
  postgres:
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=128MB
      -c work_mem=4MB
      -c wal_buffers=16MB
      -c checkpoint_completion_target=0.9
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c log_min_duration_statement=500
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 2G
        reservations:
          cpus: "1.0"
          memory: 512M
