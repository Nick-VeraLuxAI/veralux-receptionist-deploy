# Veralux Receptionist - Docker Compose Configuration
#
# Build locally:  docker compose build
# Run:            docker compose up -d
# Pull pre-built: docker compose pull && docker compose up -d
#
# When both `image` and `build` are set, `docker compose build` builds locally
# and tags with the image name. `docker compose up` uses whichever image exists.

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "5"

services:
  # =============================================================================
  # Core Services
  # =============================================================================

  control:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/veralux-control-plane:${VERSION:-latest}
    build:
      context: .
      dockerfile: control-plane/Dockerfile
    container_name: veralux-control
    restart: unless-stopped
    logging: *default-logging
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - API_KEY=${API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - LOCAL_LLM_URL=${LOCAL_LLM_URL:-}
      - TELNYX_PHONE_NUMBER=${TELNYX_PHONE_NUMBER}
      - TELNYX_API_KEY=${TELNYX_API_KEY}
      - BASE_URL=${BASE_URL:-http://localhost:4000}
      - SECRET_ENCRYPTION_KEY=${SECRET_ENCRYPTION_KEY}
      - SECRET_MANAGER=${SECRET_MANAGER:-db}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
      - INSTALLER_USERNAME=${INSTALLER_USERNAME:-VeraLux}
      - INSTALLER_PASSWORD=${INSTALLER_PASSWORD:-}
      - SAAS_MODE=${SAAS_MODE:-false}
      - ADMIN_ALLOWED_ORIGINS=${ADMIN_ALLOWED_ORIGINS:-http://localhost:4000}
      - ADMIN_RATE_USE_REDIS=true
      - ADMIN_RATE_MAX=${ADMIN_RATE_MAX:-100}
      - ADMIN_RATE_WINDOW_MS=${ADMIN_RATE_WINDOW_MS:-300000}
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # SMTP (for workflow email actions)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@veralux.ai}
      # ── Redis sync env vars (used by redisSync.ts) ──
      - TTS_MODE=${TTS_MODE:-coqui_xtts}
      - KOKORO_URL=${KOKORO_URL:-http://kokoro:7001}
      - COQUI_XTTS_URL=${COQUI_XTTS_URL:-http://xtts:7002/tts}
      - WHISPER_URL=${WHISPER_URL:-http://whisper:9000/transcribe}
      - AUDIO_PUBLIC_BASE_URL=${AUDIO_PUBLIC_BASE_URL}
      - AUDIO_STORAGE_DIR=${AUDIO_STORAGE_DIR:-/app/audio}
      - STT_CHUNK_MS=${STT_CHUNK_MS:-100}
      - STT_LANGUAGE=${STT_LANGUAGE:-en}
      - GLOBAL_CONCURRENCY_CAP=${GLOBAL_CONCURRENCY_CAP:-100}
      - TENANT_CONCURRENCY_CAP_DEFAULT=${TENANT_CONCURRENCY_CAP_DEFAULT:-10}
      - TENANT_CALLS_PER_MIN_CAP_DEFAULT=${TENANT_CALLS_PER_MIN_CAP_DEFAULT:-60}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    group_add:
      - "${DOCKER_GID:-984}"
    ports:
      - "${CONTROL_PORT:-4000}:4000"
    networks:
      - veralux-network

  runtime:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/veralux-voice-runtime:${VERSION:-latest}
    build:
      context: .
      dockerfile: veralux-voice-runtime/Dockerfile
    container_name: veralux-runtime
    restart: unless-stopped
    logging: *default-logging
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      control:
        condition: service_healthy
      brain:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/health/live"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    environment:
      - PORT=4001
      - REDIS_URL=redis://redis:6379
      - CONTROL_URL=http://control:4000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # LLM / Brain
      - BRAIN_URL=http://brain:3001/reply
      - BRAIN_TIMEOUT_MS=${BRAIN_TIMEOUT_MS:-15000}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - LOCAL_LLM_URL=${LOCAL_LLM_URL:-}
      # Telnyx Configuration
      - TELNYX_API_KEY=${TELNYX_API_KEY}
      - TELNYX_PUBLIC_KEY=${TELNYX_PUBLIC_KEY}
      - TELNYX_PHONE_NUMBER=${TELNYX_PHONE_NUMBER}
      - TELNYX_VERIFY_SIGNATURES=${TELNYX_VERIFY_SIGNATURES:-true}
      - TELNYX_ACCEPT_CODECS=${TELNYX_ACCEPT_CODECS:-PCMU,AMR-WB}
      - TELNYX_AMRWB_DECODE=${TELNYX_AMRWB_DECODE:-true}
      - PLAYBACK_PSTN_SAMPLE_RATE=${PLAYBACK_PSTN_SAMPLE_RATE:-24000}
      # URLs
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - AUDIO_PUBLIC_BASE_URL=${AUDIO_PUBLIC_BASE_URL}
      # TTS Mode
      - TTS_MODE=${TTS_MODE:-coqui_xtts}
      - KOKORO_URL=${KOKORO_URL:-http://kokoro:7001}
      - XTTS_URL=${XTTS_URL:-http://xtts:7002}
      - COQUI_XTTS_URL=${COQUI_XTTS_URL:-http://xtts:7002/tts}
      # Media/Audio
      - MEDIA_STREAM_TOKEN=${MEDIA_STREAM_TOKEN}
      - AUDIO_STORAGE_DIR=${AUDIO_STORAGE_DIR:-/app/audio}
      - WHISPER_URL=${WHISPER_URL:-http://whisper:9000/transcribe}
      # Speech-to-Text Settings
      - STT_CHUNK_MS=${STT_CHUNK_MS:-100}
      - STT_SILENCE_MS=${STT_SILENCE_MS:-500}
      - STT_SPEECH_FRAMES_REQUIRED=${STT_SPEECH_FRAMES_REQUIRED:-3}
      - STT_AEC_ENABLED=${STT_AEC_ENABLED:-true}
      - STT_RMS_FLOOR=${STT_RMS_FLOOR:-0.008}
      - STT_PEAK_FLOOR=${STT_PEAK_FLOOR:-0.02}
      # Silero VAD (neural voice activity detection — rejects background noise)
      - STT_VAD_ENABLED=${STT_VAD_ENABLED:-true}
      - STT_VAD_THRESHOLD=${STT_VAD_THRESHOLD:-0.45}
      - STT_VAD_SPEECH_FRAMES_REQUIRED=${STT_VAD_SPEECH_FRAMES_REQUIRED:-3}
      - STT_VAD_SILENCE_FRAMES_REQUIRED=${STT_VAD_SILENCE_FRAMES_REQUIRED:-6}
      - DEAD_AIR_MS=${DEAD_AIR_MS:-10000}
      # Streaming segmentation
      - BRAIN_STREAM_SEGMENT_MIN_CHARS=${BRAIN_STREAM_SEGMENT_MIN_CHARS:-40}
      - BRAIN_STREAM_SEGMENT_NEXT_CHARS=${BRAIN_STREAM_SEGMENT_NEXT_CHARS:-60}
      # Rate Limiting
      - GLOBAL_CONCURRENCY_CAP=${GLOBAL_CONCURRENCY_CAP:-100}
      - TENANT_CONCURRENCY_CAP_DEFAULT=${TENANT_CONCURRENCY_CAP_DEFAULT:-10}
      - TENANT_CALLS_PER_MIN_CAP_DEFAULT=${TENANT_CALLS_PER_MIN_CAP_DEFAULT:-60}
      - CAPACITY_TTL_SECONDS=${CAPACITY_TTL_SECONDS:-3600}
      # Control Plane integration (workflow automation)
      - CONTROL_PLANE_URL=http://control:4000
      - CONTROL_PLANE_API_KEY=${ADMIN_API_KEY}
    volumes:
      - audio-storage:/app/audio
    ports:
      - "${RUNTIME_PORT:-4001}:4001"
    networks:
      - veralux-network

  # =============================================================================
  # Brain (LLM) Service
  # =============================================================================

  brain:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/veralux-brain:${VERSION:-latest}
    build:
      context: ./veralux-voice-runtime/brain-gpt4o
      dockerfile: Dockerfile
    container_name: veralux-brain
    restart: unless-stopped
    logging: *default-logging
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    environment:
      - PORT=3001
      - OPENAI_API_KEY=${OPENAI_API_KEY:-ollama}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      - OPENAI_MODEL=${BRAIN_MODEL:-llama3.2:3b}
    # ports:
    #   - "${BRAIN_PORT:-3001}:3001"  # Internal only — accessible via Docker network
    networks:
      - veralux-network

  # =============================================================================
  # Infrastructure Services
  # =============================================================================

  redis:
    image: redis:7-alpine
    container_name: veralux-redis
    restart: unless-stopped
    logging: *default-logging
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    volumes:
      - redis-data:/data
    networks:
      - veralux-network

  postgres:
    image: postgres:16-alpine
    container_name: veralux-postgres
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-veralux} -d ${POSTGRES_DB:-veralux}"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 128M
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    # ports:
    #   - "${POSTGRES_PORT:-5432}:5432"  # Uncomment to expose for debugging
    networks:
      - veralux-network

  # =============================================================================
  # Nginx TLS Termination (Optional - enable with: docker compose --profile tls up)
  # =============================================================================

  nginx:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/veralux-nginx:${VERSION:-latest}
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: veralux-nginx
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - tls
    depends_on:
      control:
        condition: service_healthy
      runtime:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/nginx-health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/certs:/etc/nginx/certs:ro
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    networks:
      - veralux-network

  # =============================================================================
  # Tunnel Service (Optional - enable with: docker compose --profile tunnel up)
  # =============================================================================

  # Cloudflare Tunnel — exposes the instance to the internet securely
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: veralux-cloudflared
    restart: unless-stopped
    logging: *default-logging
    command: tunnel --protocol http2 run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    network_mode: host
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    depends_on:
      runtime:
        condition: service_healthy
      control:
        condition: service_healthy

  # Option B: ngrok (for quick testing)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: veralux-ngrok
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - ngrok
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command: http runtime:4001 --log stdout
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    ports:
      - "4040:4040"  # ngrok web interface
    networks:
      - veralux-network
    depends_on:
      runtime:
        condition: service_healthy

  # =============================================================================
  # GPU Services (NVIDIA GPU required - auto-selected by deploy.sh)
  # =============================================================================

  whisper-gpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/whisper-gpu:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.whisper-gpu
    container_name: veralux-whisper
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - gpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 6G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-medium}
      - WHISPER_DEVICE=cuda
      - WHISPER_COMPUTE_TYPE=float16
    # ports:
    #   - "${WHISPER_PORT:-9000}:9000"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - whisper

  kokoro-gpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/kokoro:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.kokoro
    container_name: veralux-kokoro
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - gpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - VOICE_ID=${KOKORO_VOICE_ID:-default}
      - ONNX_PROVIDER=CUDAExecutionProvider
      - PIP_EXTRA=onnxruntime-gpu
    # ports:
    #   - "${KOKORO_PORT:-7001}:7001"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - kokoro

  xtts-gpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/xtts:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.xtts
    container_name: veralux-xtts
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - gpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 6G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - LANGUAGE=${XTTS_LANGUAGE:-en}
      - COQUI_TOS_AGREED=1
      - XTTS_USE_GPU=true
    # ports:
    #   - "${XTTS_PORT:-7002}:7002"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - xtts

  # =============================================================================
  # CPU Services (No GPU required - auto-selected by deploy.sh)
  # Same images, just without NVIDIA device reservations. Slower but works anywhere.
  # =============================================================================

  whisper-cpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/whisper:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.whisper
    container_name: veralux-whisper
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - cpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 1G
    environment:
      - MODEL_SIZE=${WHISPER_MODEL_SIZE:-base}
      - CUDA_VISIBLE_DEVICES=""
    # ports:
    #   - "${WHISPER_PORT:-9000}:9000"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - whisper

  kokoro-cpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/kokoro:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.kokoro
    container_name: veralux-kokoro
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - cpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 1G
    environment:
      - VOICE_ID=${KOKORO_VOICE_ID:-default}
      - CUDA_VISIBLE_DEVICES=""
    # ports:
    #   - "${KOKORO_PORT:-7001}:7001"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - kokoro

  xtts-cpu:
    image: ${REGISTRY:-ghcr.io/nick-veraluxai}/xtts:${VERSION:-latest}
    build:
      context: ./veralux-audio-stack
      dockerfile: Dockerfile.xtts
    container_name: veralux-xtts
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - cpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 6G
        reservations:
          cpus: "1.0"
          memory: 2G
    environment:
      - LANGUAGE=${XTTS_LANGUAGE:-en}
      - CUDA_VISIBLE_DEVICES=""
      - COQUI_TOS_AGREED=1
    # ports:
    #   - "${XTTS_PORT:-7002}:7002"  # Internal only — accessible via Docker network
    networks:
      veralux-network:
        aliases:
          - xtts

# =============================================================================
# Volumes & Networks
# =============================================================================

volumes:
  postgres-data:
    name: veralux-postgres-data
  redis-data:
    name: veralux-redis-data
  audio-storage:
    name: veralux-audio-storage
  certbot-webroot:
    name: veralux-certbot-webroot
  certbot-certs:
    name: veralux-certbot-certs

networks:
  veralux-network:
    name: veralux-network
    driver: bridge
