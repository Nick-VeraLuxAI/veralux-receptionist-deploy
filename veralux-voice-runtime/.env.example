# ────────────────────────────────────────────────
# Voice Runtime Environment
# ────────────────────────────────────────────────
NODE_ENV=development
PORT=4001

# Transport mode: pstn (default) or webrtc_hd
TRANSPORT_MODE=pstn
WEBRTC_PORT=
WEBRTC_ALLOWED_ORIGINS=

# Audio diagnostics (off by default)
AUDIO_DIAGNOSTICS=false

# ────────────────────────────────────────────────
# Redis (RUNTIME REQUIRED)
# ────────────────────────────────────────────────
REDIS_URL=redis://localhost:6379

# ────────────────────────────────────────────────
# Redis Key Prefixes (CONTRACT-CRITICAL)
# ────────────────────────────────────────────────
TENANTMAP_PREFIX=tenantmap
TENANTCFG_PREFIX=tenantcfg
CAP_PREFIX=cap

# ────────────────────────────────────────────────
# Capacity Defaults (Runtime Safety Limits)
# ────────────────────────────────────────────────
GLOBAL_CONCURRENCY_CAP=30
TENANT_CONCURRENCY_CAP_DEFAULT=5
TENANT_CALLS_PER_MIN_CAP_DEFAULT=10
CAPACITY_TTL_SECONDS=120

# ────────────────────────────────────────────────
# Telnyx (Ingress + Media)
# ────────────────────────────────────────────────
TELNYX_API_KEY=replace-with-telnyx-api-key
PUBLIC_BASE_URL=https://your-runtime-public-url
AUDIO_PUBLIC_BASE_URL=https://your-runtime-public-url/audio
MEDIA_STREAM_TOKEN=replace-with-media-stream-token
AUDIO_STORAGE_DIR=/tmp/veralux-audio

# Signature enforcement
TELNYX_SKIP_SIGNATURE=true
# REQUIRE_TELNYX_SIGNATURE=true
TELNYX_STREAM_TRACK=inbound_track
AMRWB_SELECTED_RECENT_DEDUPE_N=16
TELNYX_STREAM_CODEC=
TELNYX_ACCEPT_CODECS=AMR-WB,G722,PCMU,PCMA
TELNYX_TARGET_SAMPLE_RATE=16000
TELNYX_STREAM_RESTART_MAX=1
TELNYX_INGEST_HEALTH_GRACE_MS=1200
TELNYX_INGEST_HEALTH_ENABLED=true
TELNYX_INGEST_HEALTH_RESTART_ENABLED=true
TELNYX_INGEST_POST_PLAYBACK_GRACE_MS=1200
TELNYX_INGEST_MIN_AUDIO_MS_SINCE_PLAYBACK_END=2000
TELNYX_AMRWB_MIN_DECODED_BYTES=320
TELNYX_INGEST_DECODE_FAILURES_BEFORE_FALLBACK=3
TELNYX_AMRWB_DECODE=1
TELNYX_G722_DECODE=0
TELNYX_OPUS_DECODE=0
MEDIA_DEBUG=true
TELNYX_DEBUG_MEDIA_SCHEMA=false
TELNYX_CAPTURE_ONCE=false
TELNYX_CAPTURE_CALL_ID=

# Telnyx media debug taps (raw frames + post-decode WAV)
TELNYX_DEBUG_TAP_RAW=false
TELNYX_DEBUG_TAP_POST_DECODE=false
# Debug dirs: runtime creates these at startup when set. Use /private/tmp/... on macOS if you prefer.
STT_DEBUG_DIR=/private/tmp/veralux-stt-debug
# AMRWB_DEBUG_DIR=/private/tmp/veralux-stt_bug

# STT chunk sizing (seconds)
STT_MIN_SECONDS=1.5
STT_SILENCE_MIN_SECONDS=1.0
STT_PARTIAL_MIN_MS=600
STT_RMS_FLOOR=0.015
STT_PEAK_FLOOR=0.05
STT_DISABLE_GATES=false
STT_PARTIALS_ENABLED=false
STT_VAD_ENABLED=false
STT_SPEECH_FRAMES_REQUIRED=2
STT_SILENCE_END_MS=900
STT_MAX_UTTERANCE_MS=12000

# Tier 2: measured listen-after-playback grace (300–900ms based on last segment length)
STT_POST_PLAYBACK_GRACE_MS=1200
STT_POST_PLAYBACK_GRACE_MIN_MS=300
STT_POST_PLAYBACK_GRACE_MAX_MS=900
FINAL_TAIL_CUSHION_MS=600
STT_LATE_FINAL_GRACE_MS=3000

# STT input DSP + debug
STT_HIGHPASS_ENABLED=true
STT_HIGHPASS_CUTOFF_HZ=100
STT_DEBUG_DUMP_WHISPER_WAVS=true
STT_DEBUG_DUMP_PCM16=false
STT_DEBUG_DUMP_RX_WAV=true
STT_DEBUG_DUMP_FAR_END_REF=false
STT_TRACE=true
STT_TRACE_LIMIT=200
STT_RX_POSTPROCESS_ENABLED=false
TRUTH_CAPTURE_AMRWB=true
AMRWB_ARTIFACT_DEBUG=true
AMRWB_DECODE_TRACE=true

# Tier 4: SpeexDSP AEC (requires: brew install speexdsp / apt install libspeexdsp-dev)
STT_AEC_ENABLED=false

# Whisper (required). Local server example:
WHISPER_URL=http://127.0.0.1:9000/transcribe
STT_CHUNK_MS=800
STT_SILENCE_MS=700
# STT_LANGUAGE=en
# STT_WHISPER_PROMPT=What time do you close. When do you close.

# Tier 5: Auto-calibration (noise floor + adaptive thresholds)
# STT_NOISE_FLOOR_ENABLED=true
# STT_NOISE_FLOOR_ALPHA=0.05
# STT_NOISE_FLOOR_MIN_SAMPLES=30
# STT_ADAPTIVE_RMS_MULTIPLIER=2.0
# STT_ADAPTIVE_PEAK_MULTIPLIER=2.5
# STT_ADAPTIVE_FLOOR_MIN_RMS=0.01
# STT_ADAPTIVE_FLOOR_MIN_PEAK=0.03

# Tier 5: Late-final watchdog (force final if speech but no final in X sec)
# STT_LATE_FINAL_WATCHDOG_ENABLED=true
# STT_LATE_FINAL_WATCHDOG_MS=8000
# Grace window (ms) to accept FINAL transcript after hangup (callSession). Optional.
# STT_LATE_FINAL_GRACE_MS=3000

# Dead air reprompt (required). Frames-aware timeout when no audio.
DEAD_AIR_MS=60000
DEAD_AIR_NO_FRAMES_MS=60000

# ⚠️ Temporary only — long-term use tenantcfg secrets
TELNYX_WEBHOOK_SECRET=replace-or-remove
TELNYX_PUBLIC_KEY=replace-or-remove

# ────────────────────────────────────────────────
# TTS backend selector (used when no tenant tts config; tenant config overrides)
# ────────────────────────────────────────────────
# Switch between Kokoro and Coqui XTTS: kokoro_http | coqui_xtts
TTS_MODE=kokoro_http
# Kokoro (when TTS_MODE=kokoro_http):
KOKORO_URL=https://tts.example.com/v1/kokoro
KOKORO_VOICE_ID=af_bella
# Coqui XTTS (when TTS_MODE=coqui_xtts): uncomment and set, e.g. http://localhost:7002/api/tts
# COQUI_XTTS_URL=http://localhost:7002/api/tts
# Set true when XTTS model is single-speaker (omit voice_id/speaker in requests). Default false.
# COQUI_SINGLE_SPEAKER=true
# XTTS v2 tuning (optional; sent to your Coqui server if set). Omit to use server defaults.
# COQUI_TEMPERATURE=0.65
# COQUI_LENGTH_PENALTY=1.0
# COQUI_REPETITION_PENALTY=2.0
# COQUI_TOP_K=50
# COQUI_TOP_P=0.8
# COQUI_SPEED=1.0
# COQUI_SPLIT_SENTENCES=true
# Greeting text: used to generate greeting.wav at startup and for live-TTS fallback. Omit for default.
# GREETING_TEXT=King Sod, how can I help you?
TTS_SAMPLE_RATE=16000

# ────────────────────────────────────────────────
# Brain / LLM (local vs API)
# ────────────────────────────────────────────────
# Use local default brain (keyword rules, no API). Set to true for local-only.
BRAIN_USE_LOCAL=false
# When BRAIN_USE_LOCAL=false, runtime calls this URL for replies (e.g. brain-gpt4o on port 3001).
# Leave empty to use local brain when BRAIN_USE_LOCAL=false.
BRAIN_URL=http://localhost:3001
# OpenAI API key (used by brain-gpt4o). Keep here so you can switch keys in one file.
# OPENAI_API_KEY=sk-...

# Call transcript / summarizer (no audio; caller + assistant text only)
# When set, full transcript is logged at teardown (event: call_transcript) and written to this dir as JSON.
# CALL_TRANSCRIPT_DIR=/tmp/veralux-transcripts

